<!DOCTYPE html>  
<html lang="en">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    
    <title>Configuration Settings</title>  
</head>
<style>
body {  
    font-family: Arial, sans-serif;  
    background-color: #f4f4f4;  
    margin: 0;  
    padding: 20px;  
}  

.container {  
    max-width: 800px;  
    margin: auto;  
    text-align: left;  
}  

h1 {  
    color: #333;  
    text-align: center;  
}  

.section {  
    background: #fff;  
    border-radius: 8px;  
    padding: 20px;  
    margin-bottom: 20px;  
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);  
}  

.form-group, .form-group-checkbox {  
    display: flex;  
    align-items: center;  
    margin: 15px 0;  
}  

.form-group label {  
    flex: 1; /* Takes up one part of the space */  
    margin-right: 10px;  
}  

input[type="text"],  
input[type="number"],  
select {  
    flex: 2; /* Takes up two parts of the space */  
    border: none; /* No border */  
    border-bottom: 1px solid #ccc; /* Bottom border only */  
    padding: 5px;  
    outline: none; /* Removes the outline on focus */  
}  

.checkbox-group {  
    display: flex;  
    justify-content: flex-start;  
    align-items: center;  
    margin: 10px 0;  
}  

.form-group-checkbox label {  
    margin-right: 10px; /* Space between label and checkbox */  
}  

button {  
    cursor: pointer;  
}  

.button-group {  
    margin: 20px 0;  
}  

.set-button, .get-button, .idtag-button {  
    background-color: #007BFF;  
    color: white;  
    border: none;  
    padding: 10px 15px;  
    border-radius: 5px;  
    cursor: pointer;  
    margin-right: 10px;  
}  

.set-button:hover,  
.get-button:hover {  
    background-color: #0056b3;  
}  

.clamp-info {  
    display: flex;  
    justify-content: space-between;  
}  

.clamp-info .form-group {  
    flex: 1; /* Flex to occupy space evenly */  
}
</style>
<body>  
    <div class="container" id="container-full">  
        <h1 id="topserial">MCGFF3442953</h1>  
        <form>  
            <div class="section" id="sectionfull">  
                <h2>Charinet Config</h2>  

                <div class="checkbox-group">  
                    <label for="wifi">WiFi:</label>  
                    <input type="checkbox" id="wifi" checked>  
                    
                    <label for="mobile">4G:</label>  
                    <input type="checkbox" id="mobile">  

                    <label for="lan">LAN:</label>  
                    <input type="checkbox" id="lan">  
                </div>  

                <div class="form-group">  
                    <label for="wifi-ssid">WiFi SSID:</label>  
                    <input type="text" id="wifi-ssid" value="DadashiNetwork3">  
                </div>  

                <div class="form-group">  
                    <label for="wifi-password">WiFi Password:</label>  
                    <input type="text" id="wifi-password" value="********">  
                </div>  

                <div class="form-group">  
                    <label for="apn">4G APN:</label>  
                    <input type="text" id="apn" placeholder="Max length: 32 characters">  
                </div>  

                <div class="form-group">  
                    <label for="account">4G Account:</label>  
                    <input type="text" id="account" placeholder="Max length: 32 characters">  
                </div>  

                <div class="form-group">  
                    <label for="password">4G Password:</label>  
                    <input type="text" id="password" placeholder="Max length: 32 characters">  
                </div>  
                
                <div class="form-group">  
                    <label for="ip-address">IP Address:</label>  
                    <input type="text" id="ip-address" value="192.168.1.10">  
                </div>  

                <div class="form-group">  
                    <label for="subnet-mask">Subnet Mask:</label>  
                    <input type="text" id="subnet-mask" value="255.255.255.0">  
                </div>  

                <div class="form-group">  
                    <label for="gateway">Default Gateway:</label>  
                    <input type="text" id="gateway" value="192.168.1.1">  
                </div>  

                <div class="form-group">  
                    <label for="dns">DNS:</label>  
                    <input type="text" id="dns" value="8.8.8.8">  
                </div>  

                <div class="form-group-checkbox">  
                    <label for="lan-dhcp">LAN DHCP:</label>  
                    <input type="checkbox" id="lan-dhcp">  
                </div>  

                <div class="form-group">  
                    <label for="server-url">Server URL:</label>  
                    <input type="text" id="server-url" value="wss://dchw.emapna.com/ocpp/">  
                </div>  

                <div class="form-group">  
                    <label for="serial">CP Name:</label>  
                    <input type="text" id="serial" value="MCGFF3442953">  
                </div>  

                <div class="form-group">  
                    <label for="auth-key">Authorization Key:</label>  
                    <input type="text" id="auth-key" value="********">  
                </div>  

                <div class="form-group">  
                    <label for="output-current">Output Current:</label>  
                    <input type="number" id="output-current" value="30">  
                </div>  

                <div class="form-group-checkbox">  
                    <label for="power-distribution-2">Power Distribution Enable:</label>  
                    <input type="checkbox" id="power-distribution-2">  
                </div> 

                <div class="form-group">  
                    <label for="charge-mode">Charge Mode:</label>  
                    <select id="charge-mode">  
                        <option value="APP">APP</option>
                        <option value="RFID">RFID</option>  
                        <option value="Plug & Charge">Plug & Charge</option>
                    </select>  
                </div>  

                <div class="form-group">  
                    <label for="sampling-method">Sampling Method:</label>  
                    <select id="sampling-method">  
                        <option value="CT">CT</option>  
                        <option value="Electric Meter">Electric Meter</option>  
                    </select>  
                </div>  

                <div class="form-group">  
                    <label for="home-power">Home Power Current:</label>  
                    <input type="number" id="home-power" value="100">  
                </div>  

                <div class="form-group">  
                    <label for="meter-address">Power Meter Address:</label>  
                    <input type="number" id="meter-address" value="1">  
                </div>  

                <div class="form-group">  
                    <label for="phase-rotation">Phase Rotation:</label>  
                    <input type="text" id="phase-rotation" value="NotApplicable">  
                </div>  

                <div class="form-group">  
                    <label for="solar-mode">Solar Mode:</label>  

                    <select id="solar-mode">  
                        <option value="Disable">Disable</option>  
                        <option value="Enable">Enable</option> 
                    </select>  
                </div>  

                <div class="form-group">  
                    <label for="solar-current">Solar Current From Grid:</label>  
                    <input type="number" id="solar-current" value="0">  
                </div>  

                <div class="form-group">  
                    <label for="solar-stable">Solar Stable Time:</label>  
                    <input type="number" id="solar-stable" value="60">  
                </div>  

                <div class="form-group-checkbox">  
                    <label for="dlb-mode">DLB Mode:</label>  
                    <input type="checkbox" id="dlb-mode">  
                </div>  

                <div class="form-group-checkbox">  
                    <label for="diode-detection">Diode Detection:</label>  
                    <input type="checkbox" id="diode-detection">  
                </div>  

                <div class="form-group">  
                    <label for="power-supply">Power Supply Mode:</label>  
                    <select id="power-supply">  
                        <option value="TN">TN</option>  
                    </select>  
                </div>  
        <center>
            <div class="button-group">  
                    <button type="button" class="set-button" id="setButton">SET</button>  
                    <!-- <button type="button" class="set-button">SET</button>   -->
                    <button type="button" class="get-button" id="getButton">GET</button>  
                </div>  
            </div> 
            <div class="section" id="sectionidtag">
                <center>
                    <button type="button" class="idtag-button" id="idtag-button"> ID Tags Page</button>
                </center>
                
            </div> 
        
        <div class="section" id="sectionidtagslist">
            <center>
                <div>
                    <input type="text" id="idtag-input-text" placeholder="Enter MAC address"> </input>
                    <button type="button" class="idtag-button" id="send-idtag-button"> Save</button>
                    <button type="button" class="idtag-button" id="read-idtag-button"> Read </button>
                    <br>
                </div>
                <br>
                <ul id="tags-list"></ul> 
                <div>
                    <button type="button" class="idtag-button" id="idtag-button-back-to-full-page"> Full Page</button>
                    <button type="button" class="idtag-button" id="send-to-server-button"> Send to Server</button>
                </div>

            </center>
        </div> 
        </center>
        </form>  
    </div>
</body>
<script>
    document.getElementById('idtag-button').addEventListener('click', showIDTags);
    document.getElementById('idtag-button-back-to-full-page').addEventListener('click', showFullPage);
    document.getElementById('setButton').addEventListener('click', save);  
    document.getElementById('getButton').addEventListener('click', connectFun);  
    document.getElementById('send-idtag-button').addEventListener('click', addIDTag2); 
    document.getElementById('read-idtag-button').addEventListener('click', getIDTags2); 
    document.getElementById('send-to-server-button').addEventListener('click', sendTagsToServer);  
              
    var idtagsList = document.getElementById("sectionidtagslist");
    idtagsList.style.display = "none";

    var url = window.location.search;
    var chargerSerial;
    var idTags;
    url = url.replace("?id=", "");

// if (url) 
// {
    connectFun();
// }

function save() {  
    console.log("SET");
    var finalJson = {};
    var connection = {  
        wifi: document.getElementById('wifi').checked,  
        fourG: document.getElementById('mobile').checked,  
        cable: document.getElementById('lan').checked  
    };  

    var data = (connection.wifi ? 1 : 0) + (connection.fourG ? 4 : 0) + (connection.cable ? 2 : 0);  
    finalJson.connection_selected = data.toString();  
 
    finalJson._4G_apn = document.getElementById('apn').value;  
    finalJson._4G_user = document.getElementById('account').value;  
    finalJson._4G_pass = document.getElementById('password').value;  

    finalJson.wifi_ssid = document.getElementById('wifi-ssid').value; 
    finalJson.wifi_pass = document.getElementById('wifi-password').value;  

    finalJson.ip_address = document.getElementById('ip-address').value;  
    finalJson.subnet_mask = document.getElementById('subnet-mask').value;  
    finalJson.default_gateway = document.getElementById('gateway').value;  
    finalJson.dns = document.getElementById('dns').value;  
    finalJson.dhcp = document.getElementById('lan-dhcp').checked ? "Enabled" : "Disabled";  

    finalJson.server_url = document.getElementById('server-url').value;  
    finalJson.cp_name = document.getElementById('serial').value;
    finalJson.auth_key = document.getElementById('auth-key').value;
    finalJson.power_distribution_2 = document.getElementById('power-distribution-2').checked;  

    finalJson.max_current_ac = document.getElementById('output-current').value;  
    finalJson.charge_mode = document.getElementById('charge-mode').value;  
    finalJson.sampling_method = document.getElementById('sampling-method').value;  
    finalJson.home_power = document.getElementById('home-power').value;  
    finalJson.meter_address = document.getElementById('meter-address').value;  
    finalJson.phase_rotation = document.getElementById('phase-rotation').value;  
    finalJson.solar_mode = document.getElementById('solar-mode').value;  
    finalJson.solar_current = document.getElementById('solar-current').value;  
    finalJson.solar_stable = document.getElementById('solar-stable').value;  
    finalJson.dlb_mode = document.getElementById('dlb-mode').checked;  
    finalJson.diode_detection = document.getElementById('diode-detection').checked;  
    finalJson.power_supply = document.getElementById('power-supply').value;  

    var xmlhttp = new XMLHttpRequest();  
    xmlhttp.open("POST", "http://192.168.1.1:8080/api/writeconfig");  
    xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");  
    xmlhttp.onreadystatechange = function (res) {  
        if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {  
            var chargerSerial = JSON.parse(res.target.response);  
            var xhrConfig = new XMLHttpRequest();  
            xhrConfig.open("POST", "http://192.168.1.1:8080/api/disconnect", true);  
            xhrConfig.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");  
            xhrConfig.onreadystatechange = function (res) {  
                if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {  
                    endProcess.style.display = "flex";  
                    main.style.display = "none";  
                } else if (this.status == 400 || this.status == 404 || this.status == 500) {  
                    alert("خطایی رخ داده لطفاً با پشتیبانی تماس بگیرید");  
                }  
            };  
            xhrConfig.send(JSON.stringify({ serial: "NONE" }));  
        }  
    };  
    xmlhttp.send(JSON.stringify(finalJson));
}

function populateFields(config) {
    const conn = parseInt(config.connection_selected);
    document.getElementById('serial').value = config.serial || '';
    document.getElementById('topserial').innerText = config.serial || '';
    document.getElementById('wifi').checked = !!(conn & 1);
    document.getElementById('lan').checked = !!(conn & 2);
    document.getElementById('mobile').checked = !!(conn & 4);

    document.getElementById('wifi-ssid').value = config.wifi_ssid || '';
    document.getElementById('wifi-password').value = config.wifi_pass || '';
    document.getElementById('apn').value = config._4G_apn || '';
    document.getElementById('account').value = config._4G_user || '';
    document.getElementById('password').value = config._4G_pass || '';
    document.getElementById('ip-address').value = config.ip_address || '';
    document.getElementById('subnet-mask').value = config.subnet_mask || '';
    document.getElementById('gateway').value = config.default_gateway || '';
    document.getElementById('dns').value = config.dns || '';
    document.getElementById('lan-dhcp').checked = config.dhcp === "Enabled";

    document.getElementById('server-url').value = config.server_address || '';
    document.getElementById('serial').value = config.cp_name || '';
    document.getElementById('auth-key').value = config.auth_key || '';
    document.getElementById('power-distribution-2').checked = config.power_distribution_2;

    document.getElementById('auth-key').value = config.auth_key || '';
    document.getElementById('output-current').value = config.max_current_ac || '';
    document.getElementById('charge-mode').value = config.charge_mode || 'APP';
    document.getElementById('sampling-method').value = config.sampling_method || 'CT';
    document.getElementById('home-power').value = config.home_power || '';
    document.getElementById('meter-address').value = config.meter_address || '';
    document.getElementById('phase-rotation').value = config.phase_rotation || '';
    document.getElementById('solar-mode').value = config.solar_mode || 'Disable';
    document.getElementById('solar-current').value = config.solar_current || '';
    document.getElementById('solar-stable').value = config.solar_stable || '';
    document.getElementById('dlb-mode').checked = config.dlb_mode;
    document.getElementById('diode-detection').checked = config.diode_detection;
    document.getElementById('power-supply').value = config.power_supply || 'TN';
}

function connectFun() {
    console.log("GET");
    var xhr = new XMLHttpRequest();
    xhr.open("POST", "http://192.168.1.1:8080/api/connect", true);
    xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
    xhr.onreadystatechange = function (res) {
        if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
            chargerSerial = JSON.parse(res.target.response);
            if (chargerSerial.Serial) {
                var xhrConfig = new XMLHttpRequest();
                xhrConfig.open("POST", "http://192.168.1.1:8080/api/readconfig", true);
                xhrConfig.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                xhrConfig.onreadystatechange = function (res) {
                    if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
                        var config = JSON.parse(res.target.response);
                        populateFields(config);
                    }
                };
                xhrConfig.send(JSON.stringify({ serial: url }));
            }
        }
    };
    xhr.send(JSON.stringify({ serial: url }));
}


function getIDTags() {
    var xhr = new XMLHttpRequest();
    xhr.open("POST", "http://192.168.1.1:8080/api/getidtags", true);
    xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
    xhr.onreadystatechange = function (res) {
        if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
            idTags = JSON.parse(res.target.response);

            const tagsList = document.getElementById('tags-list');
            tagsList.innerHTML = ''; // optional: clear existing list first
            idTags.forEach(tag => {
            const li = document.createElement('li');
            li.textContent = tag;
            tagsList.appendChild(li);
    });
        }
    }
    xhr.send();
}


function getIDTags2() {
    var xhr = new XMLHttpRequest();
    xhr.open("POST", "http://192.168.1.1:8080/api/getidtags", true);
    xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

    xhr.onreadystatechange = function () {
        if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
            const idTags = JSON.parse(xhr.responseText);
            console.log(idTags);

            const tagsList = document.getElementById('tags-list');
            tagsList.innerHTML = '';

            idTags.forEach(tag => {
                const li = document.createElement('li');
                li.style.display = 'flex';
                li.style.alignItems = 'center';
                li.style.gap = '8px';

                const textSpan = document.createElement('span');
                textSpan.textContent = tag;

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'X';
                deleteBtn.style.color = 'white';
                deleteBtn.style.backgroundColor = 'red';
                deleteBtn.style.border = 'none';
                deleteBtn.style.cursor = 'pointer';
                deleteBtn.style.padding = '2px 6px';

                deleteBtn.onclick = function () {
                    fetch('http://192.168.1.1:8080/api/deleteSingleDriver', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ id: tag })
                    })
                    .then(response => {
                        if (response.ok) {
                            li.remove();
                        } else {
                            alert('Failed to delete on server.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error while sending request.');
                    });
                };

                li.appendChild(textSpan);
                li.appendChild(deleteBtn);
                tagsList.appendChild(li);
            });
        }
    };

    xhr.send();
}



function showIDTags() {
    var idTagsPage = document.getElementById("sectionidtag");
    var fullPage = document.getElementById("sectionfull");
    idTagsPage.style.display = "none";
    fullPage.style.display = "none";
    idtagsList.style.display = "block";
}

function showFullPage() {
    var idTagsPage = document.getElementById("sectionidtag");
    var fullPage = document.getElementById("sectionfull");
    idTagsPage.style.display = "block";
    fullPage.style.display = "block";
    idtagsList.style.display = "none";
}

function addIDTag() 
{  
    const inputText = document.getElementById('idtag-input-text').value.trim();  
    if (inputText === '') {  
        alert('Please enter some text before saving.');  
    } else {  
        const li = document.createElement('li');  
        li.textContent = inputText;  
        document.getElementById('tags-list').appendChild(li);  
        document.getElementById('input-text').value = '';  
    }  
}

function addIDTag2() {
    const inputText = document.getElementById('idtag-input-text').value.trim();
    
    if (inputText === '') {
        alert('Please enter some text before saving.');
    } else {
        const li = document.createElement('li');
        li.style.display = 'flex';
        li.style.alignItems = 'center';
        li.style.gap = '8px';

        // Create span for the text
        const textSpan = document.createElement('span');
        textSpan.textContent = inputText;

        // Create delete button
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'X';
        deleteBtn.style.color = 'white';
        deleteBtn.style.backgroundColor = 'red';
        deleteBtn.style.border = 'none';
        deleteBtn.style.cursor = 'pointer';
        deleteBtn.style.padding = '2px 6px';

        // Add delete function
        deleteBtn.onclick = function() {
            fetch('http://192.168.1.1:8080/api/deleteSingleDriver', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ id: inputText })
            })
            .then(response => {
                if (response.ok) {
                    li.remove();
                } else {
                    alert('Failed to delete on server.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error while sending request.');
            });
        };

        li.appendChild(textSpan);
        li.appendChild(deleteBtn);

        document.getElementById('tags-list').appendChild(li);
        document.getElementById('idtag-input-text').value = '';
    }
}


function sendTagsToServer() {
    const listItems = document.querySelectorAll('#tags-list li');  
            const macAddresses = Array.from(listItems).map(li => li.textContent);  
            if (macAddresses.length === 0) {  
                alert('No MAC addresses to send.');  
                return;
            }  
            const xhr = new XMLHttpRequest();  
            xhr.open('POST', 'http://192.168.1.1:8080/api/updatedriverlist', true); // Change to your server endpoint  
            xhr.setRequestHeader('Content-Type', 'application/json');  
            const dataToSend = JSON.stringify({ macAddresses: macAddresses });  
            xhr.onreadystatechange = function() {  
                if (xhr.readyState === XMLHttpRequest.DONE) {  
                    if (xhr.status === 200) {  
                        alert('MAC addresses sent successfully!');  
                    } else {  
                        alert('Error sending MAC addresses. Please try again.');  
                    }  
                }  
            };
    xhr.send(dataToSend);
}

</script>
</html>
